
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Duck Sensors Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f8fafc;
      color: #0f172a;
      margin: 0;
      padding: 24px;
    }

    h1 {
      text-align: center;
      margin-bottom: 4px;
    }

    .version {
      text-align: center;
      color: #64748b;
      margin-bottom: 32px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 24px;
    }

    .card {
      background: white;
      padding: 16px;
      border-radius: 14px;
      box-shadow: 0 10px 20px rgba(15,23,42,0.08);
    }

    canvas {
      width: 100%;
      height: 260px;
    }
  </style>
</head>

<body>
  <h1>üê§ Duck Sensor Dashboard</h1>
  <div class="version" id="version">Version: --</div>

  <div class="grid">
    <div class="card"><canvas id="lightChart"></canvas></div>
    <div class="card"><canvas id="moistureChart"></canvas></div>
    <div class="card"><canvas id="tempChart"></canvas></div>
    <div class="card"><canvas id="humidityChart"></canvas></div>
    <div class="card"><canvas id="pressureChart"></canvas></div>
  </div>

<script>

const ENDPOINT = "http://192.168.100.23:8080/light";
const MAX_POINTS = 40;

/* ---------- Suavizado ---------- */
function smooth(value, step) {
  return Math.round(value / step) * step;
}

/* ---------- Factory ---------- */
function createChart(ctx, label, unit, min, max, step) {
  return new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label,
        data: [],
        borderWidth: 2,
        tension: 0.35,
        pointRadius: 0
      }]
    },
    options: {
      responsive: true,
      animation: false,
      plugins: {
        legend: { display: true }
      },
      scales: {
        x: {
          grid: {
            color: "#e5e7eb",
            borderDash: [4,4]
          },
          ticks: { display: false }
        },
        y: {
          min,
          max,
          ticks: {
            stepSize: step,
            callback: v => v + unit
          },
          grid: {
            color: "#e5e7eb",
            borderDash: [4,4]
          }
        }
      }
    }
  });
}

/* ---------- Charts ---------- */
const charts = {
  light: createChart(
    lightChart,
    "Luz (%)",
    "%",
    0, 100, 10
  ),
  moisture: createChart(
    moistureChart,
    "Humedad Suelo (%)",
    "%",
    0, 100, 10
  ),
  temperature: createChart(
    tempChart,
    "Temperatura (¬∞C)",
    "¬∞C",
    0, 50, 5
  ),
  humidity: createChart(
    humidityChart,
    "Humedad Ambiente (%)",
    "%",
    0, 100, 10
  ),
  pressure: createChart(
    pressureChart,
    "Presi√≥n (hPa)",
    " hPa",
    700, 1050, 10
  )
};

/* ---------- Data handling ---------- */
function push(chart, value) {
  const d = chart.data.datasets[0].data;
  const l = chart.data.labels;

  if (d.length >= MAX_POINTS) {
    d.shift();
    l.shift();
  }

  d.push(value);
  l.push(new Date().toLocaleTimeString());
  chart.update();
}

async function fetchData() {
  try {
    const res = await fetch(ENDPOINT);
    const data = await res.json();

    document.getElementById("version").innerText =
      `Version: ${data.version}`;

    push(charts.light, smooth(data.light, 5));
    push(charts.moisture, smooth(data.moisture, 5));
    push(charts.temperature, smooth(data.temperature, 0.5));
    push(charts.humidity, smooth(data.humidity, 2));
    push(charts.pressure, smooth(data.pressure, 1));

  } catch (e) {
    console.error("Fetch error", e);
  }
}

/* ---------- Polling ---------- */
setInterval(fetchData, 7000);
fetchData();
</script>

</body>
</html>
